<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Notion Embed Tool</title>

<style>
body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  margin: 40px;
  background: #ffffff;
  color: #111;
}

.section { margin-top: 28px; }

textarea {
  width: 100%;
  min-height: 220px;
  padding: 12px;
  font-family: ui-monospace, monospace;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  resize: vertical;
}

input, select {
  width: 100%;
  padding: 10px;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  margin-top: 8px;
  font-family: ui-monospace, monospace;
}

button {
  margin-top: 12px;
  padding: 10px 16px;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  background: #111;
  color: #fff;
  cursor: pointer;
}

button.secondary {
  background: #f3f4f6;
  color: #111;
}

.preview {
  margin-top: 16px;
  padding: 16px;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
}

.clock-container {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  padding: 16px;
}

.clock-card {
  padding: 12px 16px;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  min-width: 140px;
}

.clock-label {
  font-size: 13px;
  color: #6b7280;
}

.clock-time {
  font-size: 18px;
  font-weight: 600;
  margin-top: 4px;
}
</style>
</head>
<body>

<div id="app"></div>

<script>
(function() {

  const params = new URLSearchParams(window.location.search);
  const renderParam = params.get("render");
  const app = document.getElementById("app");

  // ========================================
  // RENDER MODE
  // ========================================
  if (renderParam) {

    document.body.style.margin = "0";

    let decoded;
    try {
      decoded = decodeURIComponent(renderParam);
    } catch (e) {
      // malformed percent-encoding â€” fall back to raw value
      decoded = renderParam;
      console.warn('Failed to decode render param, using raw value');
    }

    // Attempt JSON render first
    try {
      const config = JSON.parse(decoded);
      if (config.type === "clock" && Array.isArray(config.cities)) {
        renderClock(config);
        return;
      }
    } catch (e) {
      // Not JSON, continue
    }

    // Raw HTML fallback
    renderHTML(decoded);
    return;
  }

  // ========================================
  // GENERATOR MODE
  // ========================================

  app.innerHTML = `
    <h1>Notion Embed Generator</h1>

    <div class="section">
      <label>Mode</label>
      <select id="mode">
        <option value="html">Raw HTML</option>
        <option value="clock">World Clock (JSON)</option>
      </select>
    </div>

    <div class="section" id="htmlSection">
      <textarea id="htmlInput" placeholder="Paste HTML here"></textarea>
    </div>

    <div class="section" id="clockSection" style="display:none;">
      <label>City Label</label>
      <input id="clockLabel" placeholder="New York">

      <label>Timezone (IANA)</label>
      <input id="clockTZ" placeholder="America/New_York">

      <label><input type="checkbox" id="clockSeconds"> Show seconds</label>
    </div>

    <div class="section">
      <button id="generate">Generate Embed URL</button>
    </div>

    <div class="section">
      <input id="output" readonly placeholder="Embed URL">
      <button class="secondary" id="copy">Copy</button>
    </div>

    <div class="section">
      <div class="preview" id="preview"></div>
    </div>
  `;

  const mode = document.getElementById("mode");
  const htmlSection = document.getElementById("htmlSection");
  const clockSection = document.getElementById("clockSection");

  mode.addEventListener("change", () => {
    if (mode.value === "clock") {
      clockSection.style.display = "";
      htmlSection.style.display = "none";
    } else {
      clockSection.style.display = "none";
      htmlSection.style.display = "";
    }
  });

  document.getElementById("generate").addEventListener("click", () => {

    let payload = "";

    if (mode.value === "clock") {
      const label = document.getElementById("clockLabel").value.trim();
      const tz = document.getElementById("clockTZ").value.trim();
      const seconds = document.getElementById("clockSeconds").checked;

      payload = JSON.stringify({
        type: "clock",
        cities: [
          { label, timezone: tz, seconds }
        ]
      });

    } else {
      payload = document.getElementById("htmlInput").value.trim();
      if (!payload) return;
    }

    const encoded = encodeURIComponent(payload);
    const base = window.location.origin + window.location.pathname;
    const finalURL = `${base}?render=${encoded}`;

    document.getElementById("output").value = finalURL;
    renderPreview(payload);
  });

  document.getElementById("copy").addEventListener("click", async () => {
    const val = document.getElementById("output").value;
    if (!val) return;
    await navigator.clipboard.writeText(val);
  });

  function renderPreview(payload) {
    const preview = document.getElementById("preview");
    preview.innerHTML = "";

    try {
      const json = JSON.parse(payload);
      if (json.type === "clock") {
        renderClock(json, preview);
        return;
      }
    } catch {}

    preview.innerHTML = payload;
    reexecuteScripts(preview);
  }

  function renderHTML(html) {
    // Parse and sanitize known generator UI before inserting the user-supplied
    // HTML. This prevents elements from the generator (ids/classes) from being
    // injected into the rendered embed.
    try {
      const parser = new DOMParser();
      const parsed = parser.parseFromString(html, 'text/html');

      // Remove known generator controls and the host `#app` to avoid nesting
      // or duplicating the application UI inside an embed.
      const blacklist = ['#htmlInput', '#generate', '#generateBtn', '#output', '#copy', '#copyBtn', '#preview', '#app', '#mode', '#htmlSection', '#clockSection', '#clockLabel', '#clockTZ', '#clockSeconds'];
      blacklist.forEach(sel => parsed.querySelectorAll(sel).forEach(el => el.remove()));

      app.innerHTML = parsed.body.innerHTML;
      reexecuteScripts(app);
    } catch (e) {
      // If parsing fails, fall back to direct insertion (best-effort)
      app.innerHTML = html;
      reexecuteScripts(app);
    }
  }

  function reexecuteScripts(container) {
    container.querySelectorAll("script").forEach(oldScript => {
      const s = document.createElement("script");
      // copy all attributes (type, async, defer, nonce, etc.) to preserve
      // module/nomodule and other behaviors.
      for (let i = 0; i < oldScript.attributes.length; i++) {
        const attr = oldScript.attributes[i];
        try { s.setAttribute(attr.name, attr.value); } catch (e) {}
      }

      if (oldScript.src) {
        s.src = oldScript.src;
        s.async = oldScript.async;
      } else {
        s.textContent = oldScript.textContent;
      }
      oldScript.replaceWith(s);
    });
  }

  function renderClock(config, target = app) {
    const root = document.createElement("div");
    root.className = "clock-container";

    config.cities.forEach(city => {
      const card = document.createElement("div");
      card.className = "clock-card";

      const label = document.createElement("div");
      label.className = "clock-label";
      label.textContent = city.label;

      const time = document.createElement("div");
      time.className = "clock-time";

      card.appendChild(label);
      card.appendChild(time);
      root.appendChild(card);

      function update() {
        try {
          const opts = { timeZone: city.timezone, hour: "numeric", minute: "numeric" };
          if (city.seconds) opts.second = "numeric";
          const fmt = new Intl.DateTimeFormat(undefined, opts);
          time.textContent = fmt.format(new Date());
        } catch {
          time.textContent = "Invalid timezone";
        }
      }

      update();
      setInterval(update, city.seconds ? 1000 : 60000);
    });

    target.innerHTML = "";
    target.appendChild(root);
  }

})();
</script>

</body>
</html>