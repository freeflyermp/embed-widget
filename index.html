<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HTML → Notion Embed Tool</title>

<style>
:root {
  --border: #e5e7eb;
  --bg: #ffffff;
  --muted: #6b7280;
}

body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  margin: 40px;
  background: var(--bg);
  color: #111;
}

textarea {
  width: 100%;
  min-height: 220px;
  padding: 12px;
  font-family: ui-monospace, monospace;
  border: 1px solid var(--border);
  border-radius: 6px;
  resize: vertical;
}

input {
  width: 100%;
  padding: 10px;
  border: 1px solid var(--border);
  border-radius: 6px;
  margin-top: 8px;
  font-family: ui-monospace, monospace;
}

button {
  margin-top: 12px;
  padding: 10px 16px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: #111;
  color: #fff;
  cursor: pointer;
}

button.secondary {
  background: #f3f4f6;
  color: #111;
}

.section { margin-top: 28px; }

.preview {
  margin-top: 16px;
  padding: 16px;
  border: 1px solid var(--border);
  border-radius: 6px;
}

.hint {
  font-size: 13px;
  color: var(--muted);
  margin-top: 6px;
}
</style>
</head>
<body>

<div id="app"></div>

<script>
(function() {

  const params = new URLSearchParams(window.location.search);
  const renderContent = params.get("render");
  const app = document.getElementById("app");

  // ========================
  // RENDER MODE
  // ========================
  if (renderContent) {

    document.body.style.margin = "0";

    const decoded = decodeURIComponent(renderContent);

    // Parse the incoming HTML and sanitize any generator UI that may have
    // been pasted into the input. This prevents the generator controls from
    // being injected into the rendered embed under any circumstance.
    const parser = new DOMParser();
    const parsed = parser.parseFromString(decoded, "text/html");

    // Known generator element IDs/selectors that must never be included
    // inside the rendered embed. Remove them if present in the parsed doc.
    const blacklist = [
      '#htmlInput',
      '#generateBtn',
      '#output',
      '#copyBtn',
      '#preview',
      'h1'
    ];

    blacklist.forEach(sel => {
      parsed.querySelectorAll(sel).forEach(el => el.remove());
    });

    // Also remove any `id="app"` instances coming from the payload to
    // avoid nesting or duplicating the host app UI.
    parsed.querySelectorAll('#app').forEach(el => el.remove());

    // Insert sanitized body content
    app.innerHTML = parsed.body.innerHTML;

    // Re-execute script tags from the payload safely
    const scripts = app.querySelectorAll("script");
    scripts.forEach(oldScript => {
      const newScript = document.createElement("script");

      if (oldScript.src) {
        newScript.src = oldScript.src;
        newScript.async = oldScript.async;
      } else {
        newScript.textContent = oldScript.textContent;
      }

      oldScript.replaceWith(newScript);
    });

    return;
  }

  // ========================
  // GENERATOR MODE
  // ========================

  app.innerHTML = `
    <h1>HTML → Notion Embed Generator</h1>

    <div class="section">
      <textarea id="htmlInput" placeholder="Paste your HTML here"></textarea>
      <button id="generateBtn">Generate Embed Link</button>
    </div>

    <div class="section">
      <input id="output" readonly placeholder="Embed URL will appear here">
      <button class="secondary" id="copyBtn">Copy</button>
      <div class="hint">Paste this URL into Notion → /embed</div>
    </div>

    <div class="section">
      <div class="preview" id="preview"></div>
    </div>
  `;

  const htmlInput = document.getElementById("htmlInput");
  const output = document.getElementById("output");
  const preview = document.getElementById("preview");

  document.getElementById("generateBtn").addEventListener("click", () => {
    const html = htmlInput.value.trim();
    if (!html) return;

    const encoded = encodeURIComponent(html);
    const base = window.location.origin + window.location.pathname;
    const finalURL = `${base}?render=${encoded}`;

    output.value = finalURL;
    preview.innerHTML = html;
  });

  document.getElementById("copyBtn").addEventListener("click", async () => {
    if (!output.value) return;
    await navigator.clipboard.writeText(output.value);
  });

})();
</script>

</body>
</html>